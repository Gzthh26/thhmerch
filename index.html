<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>THH Merchandising Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- PWA / Add to Home Screen Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="THH Merch">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/3b82f6/FFFFFF?text=THH"> <!-- Replace with your 180x180 icon URL -->
    <link rel="manifest" href="/manifest.json"> 


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* ======================================================================
           "CLASSIC COMPACT" THEME
        ====================================================================== */
        :root {
            --c-bg: #f8fafc; /* slate-50 */
            --c-surface: #ffffff;
            --c-text-primary: #1e293b; /* slate-800 */
            --c-text-secondary: #64748b; /* slate-500 */
            --c-border: #e2e8f0; /* slate-200 */
            --c-primary: #3b82f6; /* blue-500 */
            --c-primary-hover: #2563eb; /* blue-600 */
            --c-danger: #ef4444; /* red-500 */
            --c-warning: #f59e0b; /* amber-500 */
            --c-success: #22c55e; /* green-500 */
        }

        /* Base */
        body {
            background-color: var(--c-bg);
            font-family: 'Inter', sans-serif;
            color: var(--c-text-primary);
        }

        /* Layout & Cards */
        .card {
            background-color: var(--c-surface);
            border-radius: 0.5rem;
            border: 1px solid var(--c-border);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        /* Buttons (More Compact) */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.375rem 0.75rem; /* Reduced padding */
            border-radius: 0.375rem;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .btn-primary { background-color: var(--c-primary); color: white; }
        .btn-primary:hover { background-color: var(--c-primary-hover); }
        .btn-secondary { background-color: var(--c-surface); color: var(--c-text-primary); border-color: var(--c-border); }
        .btn-secondary:hover { background-color: #f8fafc; } /* slate-50 */
        
        .btn-success { background-color: var(--c-success); color: white; }
        .btn-warning { background-color: var(--c-warning); color: white; }
        .btn-danger { background-color: var(--c-danger); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-toggle-group .btn.active {
            background-color: var(--c-primary);
            color: white;
            border-color: var(--c-primary);
        }

        /* Tables - BORDERED AND COMPACT */
        .custom-table {
            width: 100%;
            border-collapse: collapse; /* Essential for bordered look */
            border: 1px solid var(--c-border); /* Outer border */
        }
        .custom-table th {
            padding: 0.6rem 0.75rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--c-text-secondary);
            text-transform: uppercase;
            background-color: #f8fafc; /* slate-50 */
            border: 1px solid var(--c-border);
        }
        .custom-table td {
            padding: 0.5rem 0.75rem;
            font-size: 0.8125rem; /* 13px */
            border: 1px solid var(--c-border);
        }
        /* Zebra-striping */
        .custom-table tbody tr:nth-of-type(even) {
            background-color: #f8fafc; /* slate-50 */
        }
        .custom-table tbody tr:hover {
            background-color: #eff6ff; /* blue-50 */
        }
        
        .sortable:hover { background-color: #f1f5f9; cursor: pointer; }
        .sorted-asc::after { content: " ▲"; }
        .sorted-desc::after { content: " ▼"; }
        
        .comment-cell {
            white-space: pre-wrap;
            word-break: break-word;
            max-width: 250px;
        }

        /* Forms */
        .form-input {
            display: block; width: 100%; border-radius: 0.375rem;
            border: 1px solid var(--c-border); padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }
        .form-input:focus {
            outline: none; border-color: var(--c-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .form-checkbox {
            height: 1.25rem; width: 1.25rem; border-radius: 0.25rem;
            border-color: var(--c-border); color: var(--c-primary);
        }
        .form-checkbox:focus {
            ring: var(--c-primary);
        }

        /* Modal */
        .modal-card {
            background-color: var(--c-surface); border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Spinner */
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            animation: spin 1s linear infinite; border-width: 4px;
            border-style: solid; border-color: var(--c-border);
            border-top-color: var(--c-primary); border-radius: 50%;
            width: 3rem; height: 3rem;
        }
    </style>
</head>
<body>
    <div id="spinnerOverlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center hidden z-50">
        <div class="spinner"></div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 hidden bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg text-sm font-medium z-50"></div>

    <header class="bg-white sticky top-0 z-20 border-b border-gray-200">
        <div class="px-4 sm:px-6 lg:px-8 py-4">
            <h1 class="text-xl font-bold text-gray-900">THH Merchandising Report</h1>
        </div>
    </header>

    <main class="px-4 sm:px-6 lg:px-8 py-8 space-y-8">
        
        <div id="recaptureAlert" class="hidden bg-red-100 border border-red-400 text-red-700 text-sm rounded-md"></div>

        <section class="card p-6">
            <h2 class="text-lg font-semibold mb-4">Data Entry</h2>
            <form id="dataEntryForm" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4">
                <input id="vinOrStock" placeholder="VIN or Stock No." class="form-input" />
                <input id="make" placeholder="Make" class="form-input" />
                <input id="model" placeholder="Model" class="form-input" />
                <input id="trim" placeholder="Trim" class="form-input" />
                <select id="year" class="form-input"><option value="">Year</option></select>
                <input id="date" type="date" class="form-input" />
                <input id="comment" placeholder="Comment (Optional)" class="form-input col-span-full md:col-span-2" />
                <div class="sm:col-span-2 md:col-span-5 text-right mt-2 flex justify-end space-x-2">
                    <button type="button" id="undoBtn" onclick="undoLastEntry()" class="btn btn-danger disabled:opacity-50" disabled>Undo Last Operation</button>
                    <button type="button" onclick="addPending()" class="btn btn-primary">Add to Pending</button>
                </div>
            </form>
            <hr class="my-6">
            <div>
                <h3 class="text-md font-semibold mb-2">Bulk Data Entry</h3>
                <textarea id="bulkData" class="form-input w-full" rows="5" placeholder="Paste vehicle data here, one vehicle per line. Use Tabs to separate columns in this order: Model, Make, Year, Type, Vin, Stock #."></textarea>
                <div class="text-right mt-2">
                    <button type="button" onclick="parseAndAddBulk()" class="btn btn-secondary">Parse & Add All</button>
                </div>
            </div>
        </section>

        <section class="card overflow-hidden">
            <div class="p-6">
                <h2 class="text-lg font-semibold">Pending Vehicles</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th data-col="vinOrStock" class="sortable">Stock No.</th>
                            <th data-col="make" class="sortable">Make</th>
                            <th data-col="model" class="sortable">Model</th>
                            <th data-col="trim" class="sortable">Trim</th>
                            <th data-col="year" class="sortable">Year</th>
                            <th data-col="date" class="sortable">Date</th>
                            <th data-col="days" class="sortable text-center">Days</th>
                            <th>Description</th>
                            <th>Comment</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pendingTable"></tbody>
                </table>
            </div>
            <div class="p-4 flex justify-center items-center space-x-4 bg-slate-50 border-t border-slate-200">
                <button id="pendingPrevBtn" class="btn btn-secondary">Previous</button>
                <span id="pendingPageInfo" class="text-sm text-gray-600"></span>
                <button id="pendingNextBtn" class="btn btn-secondary">Next</button>
            </div>
        </section>

        <section class="card overflow-hidden">
             <div class="p-6 flex flex-col md:flex-row justify-between items-center gap-4">
                <h2 class="text-lg font-semibold">Completed Vehicles</h2>
                <input id="searchCompleted" type="text" placeholder="Search..." class="form-input w-full md:w-1/3" />
            </div>
            <div class="overflow-x-auto">
                <table class="custom-table">
                     <thead>
                        <tr>
                            <th data-col="vinOrStock" class="sortable">Stock No.</th>
                            <th data-col="make" class="sortable">Make</th>
                            <th data-col="model" class="sortable">Model</th>
                            <th data-col="trim" class="sortable">Trim</th>
                            <th data-col="year" class="sortable">Year</th>
                            <th data-col="mileage" class="sortable">Mileage</th>
                            <th data-col="date" class="sortable">Date</th>
                            <th data-col="detailed" class="sortable text-center">Detailed</th>
                            <th data-col="photoType" class="sortable">Photos</th>
                            <th data-col="recaptureNeeded" class="sortable">Recapture?</th>
                            <th data-col="halfReason" class="sortable">Half Reason</th>
                            <th data-col="days" class="sortable text-center">Days</th>
                            <th>Description</th>
                            <th>Comment</th>
                            <th>Link</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="completedTable"></tbody>
                </table>
            </div>
             <div class="p-4 flex justify-center items-center space-x-4 bg-slate-50 border-t border-slate-200">
                <button id="completedPrevBtn" class="btn btn-secondary">Previous</button>
                <span id="completedPageInfo" class="text-sm text-gray-600"></span>
                <button id="completedNextBtn" class="btn btn-secondary">Next</button>
            </div>
        </section>

        <section class="card overflow-hidden">
            <div class="p-6 flex flex-col md:flex-row justify-between items-center gap-4">
                <h2 class="text-lg font-semibold">Daily Summary for <span id="reportDate" class="text-blue-600"></span></h2>
                <input id="summaryDatePicker" type="date" class="form-input w-full md:w-auto" />
            </div>
            <div id="dailySummaryContent">
                <div class="overflow-x-auto">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Stock</th>
                                <th>Make</th>
                                <th>Model</th>
                                <th>Trim</th>
                                <th>Year</th>
                                <th>Mileage</th>
                                <th class="text-center">Detailed</th>
                                <th>Description</th>
                                <th class="text-center">Desc.</th>
                                <th class="text-center">GB</th>
                                <th class="text-center">Recaptured</th>
                                <th>Photos</th>
                                <th>Links</th>
                                <th class="text-center">Sold</th>
                            </tr>
                        </thead>
                        <tbody id="dailySummaryTable"></tbody>
                    </table>
                </div>
            </div>
            <div id="noDailyEntries" class="p-6 text-center text-gray-500 hidden">No vehicles completed today.</div>
            <div id="dailySummaryPagination" class="p-4 flex justify-center items-center space-x-4 bg-slate-50 border-t border-slate-200 hidden">
                <button id="dailySummaryPrevBtn" class="btn btn-secondary">Previous</button>
                <span id="dailySummaryPageInfo" class="text-sm text-gray-600"></span>
                <button id="dailySummaryNextBtn" class="btn btn-secondary">Next</button>
            </div>
        </section>
    </main>
    
    <!-- MODALS -->

    <!-- Complete Modal -->
    <div id="completeModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-40 p-4">
        <div class="modal-card w-full max-w-md p-6">
            <h3 class="text-lg font-semibold mb-4">Complete Vehicle</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Detailed?</label>
                    <div id="detailed-toggle" class="mt-1 grid grid-cols-2 gap-2 btn-toggle-group">
                        <button type="button" data-group="detailed" data-value="Yes" class="btn btn-secondary">Yes</button>
                        <button type="button" data-group="detailed" data-value="No" class="btn btn-secondary">No</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Photos?</label>
                    <div id="photos-toggle" class="mt-1 grid grid-cols-2 gap-2 btn-toggle-group">
                        <button type="button" data-group="photos" data-value="FP" class="btn btn-secondary">FP</button>
                        <button type="button" data-group="photos" data-value="HP" class="btn btn-secondary">HP</button>
                    </div>
                </div>
                <div id="halfReasonContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">Reason for half photos</label>
                    <div class="mt-2 space-y-2">
                        <div class="flex items-center">
                            <input id="halfReasonNotCleaned" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="halfReasonNotCleaned" class="ml-2 block text-sm text-gray-900">Awaiting Detailing</label>
                        </div>
                        <div class="flex items-center">
                            <input id="halfReasonDamage" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="halfReasonDamage" class="ml-2 block text-sm text-gray-900">Exterior Damage</label>
                        </div>
                    </div>
                </div>
                <hr/>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Photos Need Recapture?</label>
                     <div id="recapture-toggle" class="mt-1 grid grid-cols-2 gap-2 btn-toggle-group">
                        <button type="button" data-group="recapture" data-value="Yes" class="btn btn-secondary">Yes</button>
                        <button type="button" data-group="recapture" data-value="No" class="btn btn-secondary">No</button>
                    </div>
                </div>
                 <div id="recaptureCommentContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">Recapture Comment</label>
                    <textarea id="recaptureComment" class="form-input mt-1" rows="2"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" onclick="closeCompleteModal()" class="btn btn-secondary">Cancel</button>
                <button type="button" onclick="confirmComplete()" class="btn btn-success">Submit</button>
            </div>
        </div>
    </div>
    
    <!-- Description Features Modal -->
    <div id="descriptionModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-40 p-4">
        <div class="modal-card w-full max-w-md p-6">
            <h3 class="text-lg font-semibold mb-4">Vehicle Description Features</h3>
            <div class="space-y-4">
                 <input id="descMileage" placeholder="Mileage" class="form-input font-bold" />
                 <div class="grid grid-cols-2 gap-3">
                    <div class="flex items-center"><input id="descCarplay" type="checkbox" class="form-checkbox mr-3"><label for="descCarplay">Apple CarPlay & Android Auto</label></div>
                    <div class="flex items-center"><input id="descBlindSpot" type="checkbox" class="form-checkbox mr-3"><label for="descBlindSpot">Blind Spot Monitoring</label></div>
                    <div class="flex items-center"><input id="descBluetooth" type="checkbox" class="form-checkbox mr-3"><label for="descBluetooth">Bluetooth</label></div>
                    <div class="flex items-center"><input id="descHeatedSeats" type="checkbox" class="form-checkbox mr-3"><label for="descHeatedSeats">Heated Seats</label></div>
                    <div class="flex items-center"><input id="descHeatedSteering" type="checkbox" class="form-checkbox mr-3"><label for="descHeatedSteering">Heated Steering</label></div>
                    <div class="flex items-center"><input id="descInbuiltNav" type="checkbox" class="form-checkbox mr-3"><label for="descInbuiltNav">Navigation System</label></div>
                    <div class="flex items-center"><input id="descLeatherSeats" type="checkbox" class="form-checkbox mr-3"><label for="descLeatherSeats">Leather Seats</label></div>
                    <div class="flex items-center"><input id="descMultiZoneClimate" type="checkbox" class="form-checkbox mr-3"><label for="descMultiZoneClimate">Multi Zone Climate</label></div>
                    <div class="flex items-center"><input id="descParkingSensors" type="checkbox" class="form-checkbox mr-3"><label for="descParkingSensors">Parking Sensors</label></div>
                    <div class="flex items-center"><input id="descPremiumSound" type="checkbox" class="form-checkbox mr-3"><label for="descPremiumSound">Premium Sound</label></div>
                    <div class="flex items-center"><input id="descSunroof" type="checkbox" class="form-checkbox mr-3"><label for="descSunroof">Sunroof/Moonroof</label></div>
                    <div class="flex items-center"><input id="descVentilatedSeats" type="checkbox" class="form-checkbox mr-3"><label for="descVentilatedSeats">Ventilated Seats</label></div>
                    <div class="flex items-center"><input id="descWirelessCharger" type="checkbox" class="form-checkbox mr-3"><label for="descWirelessCharger">Wireless Charger</label></div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" onclick="closeDescriptionModal()" class="btn btn-secondary">Cancel</button>
                <button type="button" onclick="saveDescription()" class="btn btn-primary">Save Features</button>
            </div>
        </div>
    </div>

    <!-- View Description Modal -->
    <div id="viewDescriptionModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-40 p-4">
        <div class="modal-card w-full max-w-md p-6">
            <h3 class="text-lg font-semibold mb-4">Full Description</h3>
            <p id="fullDescriptionText" class="text-gray-700 whitespace-pre-wrap"></p>
            <div class="mt-6 flex justify-end">
                <button type="button" onclick="closeViewDescriptionModal()" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-40 p-4 overflow-y-auto">
        <div class="modal-card w-full max-w-lg p-6 my-8">
             <h3 class="text-lg font-semibold mb-4">Edit Vehicle Entry</h3>
             <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <input id="editVinOrStock" placeholder="VIN or Stock No." class="form-input" />
                <input id="editMake" placeholder="Make" class="form-input" />
                <input id="editModel" placeholder="Model" class="form-input" />
                <input id="editTrim" placeholder="Trim" class="form-input" />
                <select id="editYear" class="form-input"><option value="">Year</option></select>
                <input id="editDate" type="date" class="form-input" />
                <input id="editLink" placeholder="Website Link" class="form-input sm:col-span-2" />
             </div>
             <div class="space-y-4">
                <div class="border rounded-md p-4">
                    <h4 class="text-sm font-medium text-gray-800 mb-2">Features</h4>
                    <input id="editMileage" placeholder="Mileage" class="form-input font-bold mb-4" />
                    <div class="grid grid-cols-2 gap-2">
                        <div class="flex items-center"><input id="editCarplay" type="checkbox" class="form-checkbox mr-2"><label for="editCarplay" class="text-sm">Apple CarPlay & Android Auto</label></div>
                        <div class="flex items-center"><input id="editBlindSpot" type="checkbox" class="form-checkbox mr-2"><label for="editBlindSpot" class="text-sm">Blind Spot Monitoring</label></div>
                        <div class="flex items-center"><input id="editBluetooth" type="checkbox" class="form-checkbox mr-2"><label for="editBluetooth" class="text-sm">Bluetooth</label></div>
                        <div class="flex items-center"><input id="editHeatedSeats" type="checkbox" class="form-checkbox mr-2"><label for="editHeatedSeats" class="text-sm">Heated Seats</label></div>
                        <div class="flex items-center"><input id="editHeatedSteering" type="checkbox" class="form-checkbox mr-2"><label for="editHeatedSteering" class="text-sm">Heated Steering</label></div>
                        <div class="flex items-center"><input id="editInbuiltNav" type="checkbox" class="form-checkbox mr-2"><label for="editInbuiltNav" class="text-sm">Navigation System</label></div>
                        <div class="flex items-center"><input id="editLeatherSeats" type="checkbox" class="form-checkbox mr-2"><label for="editLeatherSeats" class="text-sm">Leather Seats</label></div>
                        <div class="flex items-center"><input id="editMultiZoneClimate" type="checkbox" class="form-checkbox mr-2"><label for="editMultiZoneClimate" class="text-sm">Multi Zone Climate</label></div>
                        <div class="flex items-center"><input id="editParkingSensors" type="checkbox" class="form-checkbox mr-2"><label for="editParkingSensors" class="text-sm">Parking Sensors</label></div>
                        <div class="flex items-center"><input id="editPremiumSound" type="checkbox" class="form-checkbox mr-2"><label for="editPremiumSound" class="text-sm">Premium Sound</label></div>
                        <div class="flex items-center"><input id="editSunroof" type="checkbox" class="form-checkbox mr-2"><label for="editSunroof" class="text-sm">Sunroof/Moonroof</label></div>
                        <div class="flex items-center"><input id="editVentilatedSeats" type="checkbox" class="form-checkbox mr-2"><label for="editVentilatedSeats" class="text-sm">Ventilated Seats</label></div>
                        <div class="flex items-center"><input id="editWirelessCharger" type="checkbox" class="form-checkbox mr-2"><label for="editWirelessCharger" class="text-sm">Wireless Charger</label></div>
                    </div>
                    <textarea id="editOtherFeatures" rows="2" placeholder="Other Features (one per line)" class="form-input w-full mt-3"></textarea>
                </div>
                <textarea id="editComment" rows="3" placeholder="Comment" class="form-input w-full"></textarea>
             </div>
             <div class="mt-6 flex justify-end space-x-3">
                <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                <button type="button" id="saveEditBtn" class="btn btn-primary">Save Changes</button>
             </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-40 p-4">
        <div class="modal-card w-full max-w-sm p-6">
            <h3 class="text-lg font-semibold mb-2">Are you sure?</h3>
            <p id="confirmMessage" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="confirmCancelBtn" class="btn btn-secondary">Cancel</button>
                <button type="button" id="confirmOkBtn" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>

<script>
    // ==========================
    // FIREBASE CONFIGURATION
    // ==========================
    const firebaseConfig = {
        apiKey: "AIzaSyC-hy3eteka35c3ZkLl7exTQ0nnFz9xhFU",
        authDomain: "thh-merch-report.firebaseapp.com",
        projectId: "thh-merch-report",
        storageBucket: "thh-merch-report.appspot.com",
        messagingSenderId: "214148544505",
        appId: "1:214148544505:web:ef4889d43b8189f5146f28"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ==========================
    // STATE & CONSTANTS
    // ==========================
    let pendingData = [], completedData = [], filteredCompletedData = [];
    let currentPendingPage = 0, currentCompletedPage = 0, currentDailySummaryPage = 0;
    const PENDING_PAGE_SIZE = 15;
    const COMPLETED_PAGE_SIZE = 10;
    const DAILY_SUMMARY_PAGE_SIZE = 10;
    const sortState = {
        pending: { col: 'createdAt', dir: 'desc' },
        completed: { col: 'completedAt', dir: 'desc' }
    };
    let currentEdit = { id: null, collection: '', data: {} };
    let onConfirmCallback = null;
    let lastOperationIds = [];

    // ==========================
    // UI & UTILITY FUNCTIONS
    // ==========================
    const showSpinner = () => document.getElementById('spinnerOverlay').classList.remove('hidden');
    const hideSpinner = () => document.getElementById('spinnerOverlay').classList.add('hidden');
    const closeModal = () => document.getElementById('editModal').classList.add('hidden');
    const closeCompleteModal = () => document.getElementById('completeModal').classList.add('hidden');
    const closeDescriptionModal = () => document.getElementById('descriptionModal').classList.add('hidden');
    const closeViewDescriptionModal = () => document.getElementById('viewDescriptionModal').classList.add('hidden');
    const closeConfirmModal = () => document.getElementById('confirmModal').classList.add('hidden');

    const showToast = msg => {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.remove('hidden');
        setTimeout(() => t.classList.add('hidden'), 3000);
    };
    const getTodayDate = () => new Date().toISOString().split('T')[0];
    const getDisplayDate = dateStr => new Date(dateStr + 'T00:00:00').toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
    const calculateDays = dateStr => Math.floor((new Date() - new Date(dateStr + 'T00:00:00')) / 86400000);
    const capitalizeFirst = str => str ? str.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') : '';


    function openConfirmModal(message, callback) {
        onConfirmCallback = callback;
        document.getElementById('confirmMessage').textContent = message;
        document.getElementById('confirmModal').classList.remove('hidden');
    }

    function openViewDescriptionModal(title, text) {
        document.getElementById('fullDescriptionText').textContent = text || "No content available.";
        document.getElementById('viewDescriptionModal').querySelector('h3').textContent = title;
        document.getElementById('viewDescriptionModal').classList.remove('hidden');
    }

    // ==========================
    // RENDERING LOGIC
    // ==========================
    function applySort(tableKey, dataArray) {
        const { col, dir } = sortState[tableKey];
        return [...dataArray].sort((a, b) => {
            // Helper to get comparable values from a document
            const getValue = (doc, column) => {
                const data = doc.data;
                switch (column) {
                    case 'completedAt':
                    case 'createdAt':
                        // Convert Firestore Timestamp to milliseconds for accurate sorting.
                        // Default to 0 if the timestamp doesn't exist (for older data).
                        return data[column]?.toMillis() || 0;
                    case 'days':
                        return calculateDays(data.date);
                    case 'vinOrStock':
                        return data.vinOrStock || data.stock || '';
                    default:
                        // Default case for string-based sorting
                        return data[column] || '';
                }
            };

            const valA = getValue(a, col);
            const valB = getValue(b, col);

            let comparison = 0;
            // Use numeric comparison for numbers, and localeCompare for strings.
            if (typeof valA === 'number' && typeof valB === 'number') {
                comparison = valA - valB;
            } else {
                comparison = String(valA).localeCompare(String(valB), undefined, { numeric: true });
            }

            // Apply sort direction
            return dir === 'asc' ? comparison : -comparison;
        });
    }

    function renderTable(key, tbodyId, data, page, size, rowFunc, emptyMsg) {
        const tbody = document.getElementById(tbodyId);
        const sorted = applySort(key, data);
        const totalItems = sorted.length, totalPages = Math.ceil(totalItems / size) || 1;
        page = Math.max(0, Math.min(page, totalPages - 1));
        if (key === 'pending') currentPendingPage = page; else currentCompletedPage = page;
        
        const pageSlice = sorted.slice(page * size, (page * size) + size);
        tbody.innerHTML = pageSlice.length ? pageSlice.map(rowFunc).join('') : `<tr><td colspan="16" class="text-center py-10 text-gray-500">${emptyMsg}</td></tr>`;
        
        document.getElementById(`${key}PageInfo`).textContent = `Page ${page + 1} of ${totalPages}`;
        document.getElementById(`${key}PrevBtn`).disabled = page === 0;
        document.getElementById(`${key}NextBtn`).disabled = page >= totalPages - 1;
    }

    function getFeaturesText(data) {
        const features = data.descriptionFeatures || {};
        const descriptionItems = [];

        if (features.appleCarPlay) descriptionItems.push('Apple CarPlay & Android Auto');
        if (features.blindSpot) descriptionItems.push('Blind Spot Monitoring');
        if (features.bluetooth) descriptionItems.push('Bluetooth');
        if (features.heatedSeats) descriptionItems.push('Heated Seats');
        if (features.heatedSteering) descriptionItems.push('Heated Steering');
        if (features.inbuiltNav) descriptionItems.push('Navigation System');
        if (features.leatherSeats) descriptionItems.push('Leather Seats');
        if (features.multiZoneClimate) descriptionItems.push('Multi Zone Climate');
        if (features.parkingSensors) descriptionItems.push('Parking Sensors');
        if (features.premiumSound) descriptionItems.push('Premium Sound');
        if (features.sunroof) descriptionItems.push('Sunroof/Moonroof');
        if (features.ventilatedSeats) descriptionItems.push('Ventilated Seats');
        if (features.wirelessCharger) descriptionItems.push('Wireless Charger');
        if (features.other) {
            features.other.split('\n').forEach(f => {
                if (f.trim()) descriptionItems.push(f.trim());
            });
        }
        return descriptionItems.join(' | ');
    }

    const createPendingRow = doc => {
        const d = doc.data, days = calculateDays(d.date);
        const badgeStyle = days > 3 ? 'text-red-700 bg-red-100' : 'text-gray-700 bg-gray-100';
        
        let descriptionText = getFeaturesText(d);
        
        const escapedDescriptionText = (descriptionText || '').replace(/`/g, '\\`');
        const escapedComment = (d.comment || '').replace(/`/g, '\\`');

        return `<tr>
            <td class="font-semibold text-gray-900">${d.vinOrStock || d.stock || ''}</td>
            <td>${d.make}</td>
            <td>${d.model}</td>
            <td>${d.trim || ''}</td>
            <td>${d.year}</td>
            <td>${d.date}</td>
            <td class="text-center"><span class="px-2 py-0.5 text-xs rounded-full font-medium ${badgeStyle}">${days}</span></td>
            <td class="text-gray-500 truncate cursor-pointer" style="max-width: 150px;" ondblclick="openViewDescriptionModal('Description', \`${escapedDescriptionText}\`)" title="Double-click to view full text">${descriptionText.split('\n')[0]}</td>
            <td class="comment-cell truncate cursor-pointer" ondblclick="openViewDescriptionModal('Comment', \`${escapedComment}\`)" title="Double-click to view full text">${d.comment || ''}</td>
            <td><div class="flex items-center justify-center space-x-1">
                <button onclick="openDescriptionModal('${doc.id}')" class="btn btn-secondary text-xs">Features</button>
                <button onclick="openCompleteModal('${doc.id}')" class="btn btn-success text-xs">Complete</button>
                <button onclick="openEditModal('${doc.id}', 'pending_vehicles')" class="btn btn-warning text-xs">Edit</button>
                <button onclick="deleteEntry('${doc.id}', 'pending_vehicles')" class="btn btn-danger text-xs">Del</button>
            </div></td></tr>`;
    };
    
    const createCompletedRow = doc => {
        const d = doc.data;
        const stockClass = (d.photoType === 'HP' && calculateDays(d.date) > 7) ? (calculateDays(d.date) > 14 ? 'bg-red-100' : 'bg-amber-100') : '';
        const detailedIcon = d.detailed === 'Yes' 
            ? `<span class="text-green-500 font-bold text-lg">✓</span>` 
            : `<span class="text-red-500 font-bold text-lg">✗</span>`;
        
        let descriptionText = getFeaturesText(d);
        
        const escapedDescriptionText = (descriptionText || '').replace(/`/g, '\\`');
        const escapedComment = (d.comment || '').replace(/`/g, '\\`');
        const escapedHalfReason = (d.halfReason || '').replace(/`/g, '\\`');

        let recaptureClass = '';
        if (d.recaptureNeeded === 'Yes' && calculateDays(d.date) > 5) {
            recaptureClass = 'bg-red-100 text-red-700 font-bold';
        }

        return `<tr class="${d.isSold ? 'opacity-50' : ''}">
            <td class="font-semibold text-gray-900 ${stockClass}">${d.vinOrStock || d.stock || ''}</td>
            <td>${d.make}</td>
            <td>${d.model}</td>
            <td>${d.trim || ''}</td>
            <td>${d.year}</td>
            <td>${(d.descriptionFeatures && d.descriptionFeatures.mileage) || d.mileage || ''}</td>
            <td>${d.date}</td>
            <td class="text-center">${detailedIcon}</td>
            <td>${d.photoType || ''}</td>
            <td class="${recaptureClass}">${d.recaptureNeeded || 'No'}</td>
            <td class="text-gray-500 truncate cursor-pointer" ondblclick="openViewDescriptionModal('Half Photo Reason', \`${escapedHalfReason}\`)" title="Double-click to view full text">${d.halfReason || ''}</td>
            <td class="text-center">${calculateDays(d.originalEntryDate || d.date)}</td>
            <td class="text-gray-500 truncate cursor-pointer" style="max-width: 150px;" ondblclick="openViewDescriptionModal('Description', \`${escapedDescriptionText}\`)" title="Double-click to view full text">${descriptionText.split('\n')[0]}</td>
            <td class="comment-cell truncate cursor-pointer" ondblclick="openViewDescriptionModal('Comment', \`${escapedComment}\`)" title="Double-click to view full text">${d.comment || ''}</td>
            <td>${d.link ? `<a href="${d.link}" target="_blank" class="text-blue-600 hover:underline">THH</a>` : ''}</td>
            <td><div class="flex items-center justify-center space-x-1">
                <button onclick="moveToPending('${doc.id}')" class="btn btn-secondary text-xs">Recapture</button>
                <button onclick="toggleSoldStatus('${doc.id}', ${!!d.isSold})" class="btn ${d.isSold ? 'btn-secondary' : 'btn-success'} text-xs">Sold</button>
                <button onclick="openEditModal('${doc.id}', 'vehicles')" class="btn btn-warning text-xs">Edit</button>
                <button onclick="deleteEntry('${doc.id}', 'vehicles')" class="btn btn-danger text-xs">Del</button>
            </div></td></tr>`;
    };

    function renderDailySummary(selectedDate, page = 0) {
        const reportDate = selectedDate || getTodayDate();
        document.getElementById('reportDate').textContent = getDisplayDate(reportDate);
        
        let dailyEntries = completedData.filter(doc => doc.data.date === reportDate);
        dailyEntries.sort((a,b) => (b.data.completedAt?.toMillis() || 0) - (a.data.completedAt?.toMillis() || 0));

        const paginationContainer = document.getElementById('dailySummaryPagination');
        const noEntriesMsg = document.getElementById('noDailyEntries');
        const contentContainer = document.getElementById('dailySummaryContent');
        
        if (dailyEntries.length === 0) {
            contentContainer.classList.add('hidden');
            noEntriesMsg.classList.remove('hidden');
            paginationContainer.classList.add('hidden');
            return;
        }

        contentContainer.classList.remove('hidden');
        noEntriesMsg.classList.add('hidden');

        const totalItems = dailyEntries.length;
        const totalPages = Math.ceil(totalItems / DAILY_SUMMARY_PAGE_SIZE) || 1;
        page = Math.max(0, Math.min(page, totalPages - 1));
        currentDailySummaryPage = page;
        
        const pageSlice = dailyEntries.slice(page * DAILY_SUMMARY_PAGE_SIZE, (page * DAILY_SUMMARY_PAGE_SIZE) + DAILY_SUMMARY_PAGE_SIZE);
        
        const tbody = document.getElementById('dailySummaryTable');
        tbody.innerHTML = pageSlice.map(doc => {
            const d = doc.data;
            const toggleButton = (field, value) => `<button onclick="toggleSummaryStatus('${doc.id}', '${field}', ${!!value})" class="btn ${value ? 'btn-success' : 'btn-secondary'} text-xs">${value ? 'Yes' : 'No'}</button>`;
            const detailedIcon = d.detailed === 'Yes' 
                ? `<span class="text-green-500 font-bold text-lg">✓</span>` 
                : `<span class="text-red-500 font-bold text-lg">✗</span>`;
            
            let descriptionText = getFeaturesText(d);
            
            const escapedDescriptionText = (descriptionText || '').replace(/`/g, '\\`');

            return `<tr>
                <td class="font-semibold text-gray-900">${d.vinOrStock || d.stock || ''}</td>
                <td>${d.make}</td>
                <td>${d.model}</td>
                <td>${d.trim || ''}</td>
                <td>${d.year}</td>
                <td>${(d.descriptionFeatures && d.descriptionFeatures.mileage) || d.mileage || ''}</td>
                <td class="text-center">${detailedIcon}</td>
                <td class="text-gray-500 truncate cursor-pointer" style="max-width: 150px;" ondblclick="openViewDescriptionModal('Description', \`${escapedDescriptionText}\`)">${descriptionText.split('\n')[0]}</td>
                <td class="text-center">${toggleButton('descriptionUploaded', d.descriptionUploaded)}</td>
                <td class="text-center">${toggleButton('gloveboxDocuments', d.gloveboxDocuments)}</td>
                <td class="text-center">${toggleButton('recaptured', d.recaptured)}</td>
                <td>${d.photoType}</td>
                <td>${d.link ? `<a href="${d.link}" target="_blank" class="text-blue-600 hover:underline">THH</a>` : ''}</td>
                <td class="text-center">
                     <button onclick="toggleSoldStatus('${doc.id}', ${!!d.isSold})" class="btn ${d.isSold ? 'btn-warning' : 'btn-danger'} text-xs">Sold</button>
                </td>
            </tr>`;
        }).join('');

        if (totalPages > 1) {
            paginationContainer.classList.remove('hidden');
            document.getElementById(`dailySummaryPageInfo`).textContent = `Page ${page + 1} of ${totalPages}`;
            document.getElementById(`dailySummaryPrevBtn`).disabled = page === 0;
            document.getElementById(`dailySummaryNextBtn`).disabled = page >= totalPages - 1;
        } else {
            paginationContainer.classList.add('hidden');
        }
    }

    function renderRecaptureAlerts() {
        const alertContainer = document.getElementById('recaptureAlert');
        const overdueRecaptures = completedData.filter(doc => {
            const d = doc.data;
            return d.recaptureNeeded === 'Yes' && calculateDays(d.date) > 7;
        });

        if (overdueRecaptures.length > 0) {
            const alertHTML = overdueRecaptures.map(doc => {
                const d = doc.data;
                const daysOver = calculateDays(d.date);
                return `<div class="p-2 border-b border-red-300 last:border-b-0">
                            <strong>Stock:</strong> ${d.vinOrStock || d.stock} | 
                            <strong>Make:</strong> ${d.make} | 
                            <strong>Model:</strong> ${d.model} | 
                            <strong>Days Overdue:</strong> ${daysOver}
                        </div>`;
            }).join('');
            alertContainer.innerHTML = `<div class="font-bold p-2 border-b border-red-300">Recapture Required (Over 7 Days)</div>${alertHTML}`;
            alertContainer.classList.remove('hidden');
        } else {
            alertContainer.classList.add('hidden');
        }
    }

    // ==========================
    // ACTIONS
    // ==========================
    async function addPending(isBulk = false) {
        const formData = {
            vinOrStock: document.getElementById('vinOrStock').value.trim().toUpperCase(),
            make: capitalizeFirst(document.getElementById('make').value.trim()),
            model: capitalizeFirst(document.getElementById('model').value.trim()),
            trim: document.getElementById('trim').value.trim(),
            year: document.getElementById('year').value,
            date: document.getElementById('date').value,
            comment: document.getElementById('comment').value.trim(),
            descriptionFeatures: {},
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        if (!formData.vinOrStock || !formData.make || !formData.model || !formData.year || !formData.date) {
            if (!isBulk) showToast('Please fill all required fields.');
            return null;
        }
        if (pendingData.some(item => (item.data.vinOrStock || item.data.stock) === formData.vinOrStock)) {
            if (!isBulk) showToast('Duplicate Stock/VIN in Pending list.');
            return null;
        }
        
        if (!isBulk) showSpinner();
        try {
            const docRef = await db.collection('pending_vehicles').add(formData);
            if (!isBulk) {
                showToast('Vehicle added successfully!');
                lastOperationIds = [docRef.id];
                document.getElementById('undoBtn').disabled = false;
                document.getElementById('dataEntryForm').reset();
                document.getElementById('date').value = getTodayDate();
            }
            return docRef;
        } catch (e) { 
            console.error(e); 
            if (!isBulk) showToast('Error adding entry.');
            return null;
        } finally { 
            if (!isBulk) hideSpinner();
        }
    }

    async function parseAndAddBulk() {
        const text = document.getElementById('bulkData').value.trim();
        if (!text) return showToast('Paste data into the bulk entry field.');

        showSpinner();
        lastOperationIds = [];
        const lines = text.split('\n').filter(line => line.trim() !== '');
        let successCount = 0;
        let errorCount = 0;

        for (const line of lines) {
            let parsedData;
            if (line.includes('\t')) {
                const parts = line.split('\t');
                parsedData = {
                    model: parts[0] || '',
                    make: parts[1] || '',
                    year: parts[2] || '',
                    stockNo: parts[5] || '',
                    trim: '' // Trim is not in this format
                };
            } else {
                parsedData = parseSingleLine(line);
            }

            if (parsedData && parsedData.stockNo && parsedData.make && parsedData.model && parsedData.year) {
                document.getElementById('vinOrStock').value = parsedData.stockNo;
                document.getElementById('make').value = parsedData.make;
                document.getElementById('model').value = parsedData.model;
                document.getElementById('year').value = parsedData.year;
                document.getElementById('trim').value = parsedData.trim;
                document.getElementById('date').value = getTodayDate();
                document.getElementById('comment').value = '';

                const docRef = await addPending(true);
                if (docRef) {
                    successCount++;
                    lastOperationIds.push(docRef.id);
                } else {
                    errorCount++;
                }
            } else {
                errorCount++;
            }
            await new Promise(resolve => setTimeout(resolve, 200));
        }
        
        document.getElementById('dataEntryForm').reset();
        document.getElementById('date').value = getTodayDate();
        document.getElementById('bulkData').value = '';
        document.getElementById('undoBtn').disabled = successCount === 0;
        hideSpinner();
        showToast(`Bulk operation finished. Added: ${successCount}. Failed/Skipped: ${errorCount}.`);
    }

    function parseSingleLine(line) {
        let remainingLine = line.trim();
        const makes = [
            'Acura', 'Audi', 'BMW', 'Buick', 'Cadillac', 'Chevrolet', 'Chrysler', 'Dodge', 'Ford', 'GMC',
            'Honda', 'Hyundai', 'Infiniti', 'Jaguar', 'Jeep', 'Kia', 'Land Rover', 'Lexus', 'Lincoln',
            'Mazda', 'Mercedes-Benz', 'Mitsubishi', 'Nissan', 'Ram', 'Subaru', 'Tesla', 'Toyota', 'Volkswagen', 'VW', 'Volvo'
        ].sort((a, b) => b.length - a.length);

        remainingLine = remainingLine.replace(/[A-Z0-9]{17}/g, '').trim();
        remainingLine = remainingLine.replace(/\b(Used|New|CPO)\b/ig, '').trim();

        const parts = remainingLine.split(/\s+/);
        const stockNo = parts.pop();
        remainingLine = parts.join(' ').trim();

        let year = '';
        const yearMatch = remainingLine.match(/\b(19|20)\d{2}\b/);
        if (yearMatch) {
            year = yearMatch[0];
            remainingLine = remainingLine.replace(year, '').trim();
        }

        let make = '';
        let model = '';
        
        for (const carMake of makes) {
            const makeIndex = remainingLine.toLowerCase().lastIndexOf(carMake.toLowerCase());
            if (makeIndex !== -1) {
                make = carMake === 'VW' ? 'Volkswagen' : carMake;
                model = remainingLine.substring(0, makeIndex).trim();
                break;
            }
        }
        
        if (!make) {
            for (const carMake of makes) {
                if (remainingLine.toLowerCase().endsWith(carMake.toLowerCase().replace(/\s/g, ''))) {
                    make = carMake === 'VW' ? 'Volkswagen' : carMake;
                    model = remainingLine.substring(0, remainingLine.toLowerCase().lastIndexOf(carMake.toLowerCase().replace(/\s/g, ''))).trim();
                    break;
                }
            }
        }

        if (!make) {
            model = remainingLine;
        }

        return {
            stockNo: stockNo ? stockNo.toUpperCase() : '',
            make: capitalizeFirst(make),
            model: capitalizeFirst(model),
            year: year,
            trim: ''
        };
    }
    
    async function confirmComplete() {
        const isNotCleaned = document.getElementById('halfReasonNotCleaned').checked;
        const isDamaged = document.getElementById('halfReasonDamage').checked;
        let halfReasons = [];
        if (isNotCleaned) halfReasons.push("Awaiting Detailing");
        if (isDamaged) halfReasons.push("Exterior Damage");
        const halfReasonText = halfReasons.join(', ');

        const getSelectedValue = (groupName) => {
            const activeButton = document.querySelector(`#${groupName}-toggle .btn.active`);
            return activeButton ? activeButton.dataset.value : '';
        };

        const completeData = {
            detailed: getSelectedValue('detailed'),
            photoType: getSelectedValue('photos'),
            halfReason: halfReasonText,
            recaptureNeeded: getSelectedValue('recapture'),
            recaptureComment: document.getElementById('recaptureComment').value.trim()
        };
        if (!completeData.detailed || !completeData.photoType || !completeData.recaptureNeeded) return showToast('Please fill out all fields.');
        if (completeData.photoType === 'HP' && !completeData.halfReason) return showToast('A reason for half photos is required.');

        showSpinner();
        try {
            const docRef = db.collection('pending_vehicles').doc(currentEdit.id);
            const doc = await docRef.get();
            if (doc.exists) {
                const pendingDocData = doc.data();
                await db.collection('vehicles').add({
                    ...pendingDocData, ...completeData, originalEntryDate: doc.data().date, date: getTodayDate(),
                    completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    recaptured: false, descriptionUploaded: false, gloveboxDocuments: false, isSold: false
                });
                await docRef.delete();
                showToast('Vehicle marked as complete!');
                closeCompleteModal();
            }
        } catch (e) { console.error(e); showToast('Error completing vehicle.'); } finally { hideSpinner(); }
    }

    function openCompleteModal(id) {
        currentEdit.id = id;
        document.querySelectorAll('.btn-toggle-group .btn').forEach(button => {
            button.classList.remove('active', 'btn-primary');
            button.classList.add('btn-secondary');
        });
        document.getElementById('halfReasonNotCleaned').checked = false;
        document.getElementById('halfReasonDamage').checked = false;
        document.getElementById('recaptureComment').value = '';
        document.getElementById('halfReasonContainer').classList.add('hidden');
        document.getElementById('recaptureCommentContainer').classList.add('hidden');
        document.getElementById('completeModal').classList.remove('hidden');
    }

    async function openDescriptionModal(id) {
        currentEdit.id = id;
        showSpinner();
        try {
            const doc = await db.collection('pending_vehicles').doc(id).get();
            currentEdit.data = doc.data();
            const features = currentEdit.data.descriptionFeatures || {};
            document.getElementById('descMileage').value = features.mileage || '';
            document.getElementById('descCarplay').checked = !!features.appleCarPlay;
            document.getElementById('descBlindSpot').checked = !!features.blindSpot;
            document.getElementById('descBluetooth').checked = !!features.bluetooth;
            document.getElementById('descHeatedSeats').checked = !!features.heatedSeats;
            document.getElementById('descHeatedSteering').checked = !!features.heatedSteering;
            document.getElementById('descInbuiltNav').checked = !!features.inbuiltNav;
            document.getElementById('descLeatherSeats').checked = !!features.leatherSeats;
            document.getElementById('descMultiZoneClimate').checked = !!features.multiZoneClimate;
            document.getElementById('descParkingSensors').checked = !!features.parkingSensors;
            document.getElementById('descPremiumSound').checked = !!features.premiumSound;
            document.getElementById('descSunroof').checked = !!features.sunroof;
            document.getElementById('descVentilatedSeats').checked = !!features.ventilatedSeats;
            document.getElementById('descWirelessCharger').checked = !!features.wirelessCharger;
            document.getElementById('descriptionModal').classList.remove('hidden');
        } catch(e) { console.error(e); showToast('Error fetching description.'); } finally { hideSpinner(); }
    }

    async function saveDescription() {
        const descriptionFeatures = {
            mileage: document.getElementById('descMileage').value.trim(),
            appleCarPlay: document.getElementById('descCarplay').checked,
            blindSpot: document.getElementById('descBlindSpot').checked,
            bluetooth: document.getElementById('descBluetooth').checked,
            heatedSeats: document.getElementById('descHeatedSeats').checked,
            heatedSteering: document.getElementById('descHeatedSteering').checked,
            inbuiltNav: document.getElementById('descInbuiltNav').checked,
            leatherSeats: document.getElementById('descLeatherSeats').checked,
            multiZoneClimate: document.getElementById('descMultiZoneClimate').checked,
            parkingSensors: document.getElementById('descParkingSensors').checked,
            premiumSound: document.getElementById('descPremiumSound').checked,
            sunroof: document.getElementById('descSunroof').checked,
            ventilatedSeats: document.getElementById('descVentilatedSeats').checked,
            wirelessCharger: document.getElementById('descWirelessCharger').checked,
        };
        showSpinner();
        try {
            await db.collection('pending_vehicles').doc(currentEdit.id).update({ descriptionFeatures });
            showToast('Description features saved!');
            closeDescriptionModal();
        } catch (e) { console.error(e); showToast('Error saving description.'); } finally { hideSpinner(); }
    }
    
    function openEditModal(id, collection) {
        currentEdit.id = id;
        currentEdit.collection = collection;
        showSpinner();
        db.collection(collection).doc(id).get().then(doc => {
            if(doc.exists) {
                const d = doc.data();
                currentEdit.data = d;
                
                document.getElementById('editVinOrStock').value = d.vinOrStock || d.stock || '';
                document.getElementById('editMake').value = d.make || '';
                document.getElementById('editModel').value = d.model || '';
                document.getElementById('editTrim').value = d.trim || '';
                document.getElementById('editYear').value = d.year || '';
                document.getElementById('editDate').value = d.date || '';
                document.getElementById('editComment').value = d.comment || '';
                
                document.getElementById('editLink').value = d.link || '';

                const features = d.descriptionFeatures || {};
                document.getElementById('editMileage').value = features.mileage || d.mileage || '';
                document.getElementById('editCarplay').checked = !!features.appleCarPlay;
                document.getElementById('editBlindSpot').checked = !!features.blindSpot;
                document.getElementById('editBluetooth').checked = !!features.bluetooth;
                document.getElementById('editHeatedSeats').checked = !!features.heatedSeats;
                document.getElementById('editHeatedSteering').checked = !!features.heatedSteering;
                document.getElementById('editInbuiltNav').checked = !!features.inbuiltNav;
                document.getElementById('editLeatherSeats').checked = !!features.leatherSeats;
                document.getElementById('editMultiZoneClimate').checked = !!features.multiZoneClimate;
                document.getElementById('editParkingSensors').checked = !!features.parkingSensors;
                document.getElementById('editPremiumSound').checked = !!features.premiumSound;
                document.getElementById('editSunroof').checked = !!features.sunroof;
                document.getElementById('editVentilatedSeats').checked = !!features.ventilatedSeats;
                document.getElementById('editWirelessCharger').checked = !!features.wirelessCharger;
                document.getElementById('editOtherFeatures').value = features.other || '';

                document.getElementById('editModal').classList.remove('hidden');
            }
        }).catch(e => { console.error(e); showToast('Error fetching document.'); }).finally(hideSpinner);
    }
    
    async function deleteEntry(id, collection) {
        openConfirmModal('Are you sure you want to permanently delete this entry?', async () => {
            showSpinner();
            try {
                await db.collection(collection).doc(id).delete();
                showToast('Entry deleted!');
            } catch(e) { console.error(e); showToast('Error deleting entry.'); } finally { hideSpinner(); }
        });
    }

    async function undoLastEntry() {
        if (lastOperationIds.length === 0) {
            showToast('No operation to undo.');
            return;
        }
        const message = `Are you sure you want to undo the last operation? This will delete ${lastOperationIds.length} entr${lastOperationIds.length > 1 ? 'ies' : 'y'}.`;
        openConfirmModal(message, async () => {
            showSpinner();
            try {
                const deletePromises = lastOperationIds.map(id => db.collection('pending_vehicles').doc(id).delete());
                await Promise.all(deletePromises);
                showToast(`Successfully undone the last operation (${lastOperationIds.length} entries removed).`);
                lastOperationIds = [];
                document.getElementById('undoBtn').disabled = true;
            } catch (e) {
                console.error('Error undoing operation:', e);
                showToast('An error occurred while trying to undo.');
            } finally {
                hideSpinner();
            }
        });
    }

    async function toggleSummaryStatus(id, field, currentValue) {
        showSpinner();
        try {
            await db.collection('vehicles').doc(id).update({ [field]: !currentValue });
            showToast('Status updated.');
        } catch (e) { console.error(e); showToast('Error updating status.'); } finally { hideSpinner(); }
    }

    async function toggleSoldStatus(id, currentValue) {
        showSpinner();
        try {
            await db.collection('vehicles').doc(id).update({ isSold: !currentValue });
            showToast(`Vehicle marked as ${!currentValue ? 'Sold' : 'Available'}.`);
        } catch (e) { console.error(e); showToast('Error updating sold status.'); } finally { hideSpinner(); }
    }

    async function moveToPending(id) {
        openConfirmModal('Are you sure you want to move this vehicle back to the Pending list for recapture?', async () => {
            showSpinner();
            try {
                const docRef = db.collection('vehicles').doc(id);
                const doc = await docRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    const pendingData = {
                        vinOrStock: data.vinOrStock || data.stock || '',
                        make: data.make,
                        model: data.model,
                        trim: data.trim,
                        year: data.year,
                        link: data.link || '',
                        date: getTodayDate(), // Reset date to today
                        comment: `Moved back for recapture. Original comment: ${data.comment || ''}`, // Pre-fill a comment
                        descriptionFeatures: {
                            ...(data.descriptionFeatures || {}),
                            mileage: (data.descriptionFeatures && data.descriptionFeatures.mileage) || data.mileage || ''
                        },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await db.collection('pending_vehicles').add(pendingData);
                    await docRef.delete();
                    showToast('Vehicle moved to Pending for recapture.');
                }
            } catch(e) {
                console.error(e);
                showToast('Error moving vehicle.');
            } finally {
                hideSpinner();
            }
        });
    }


    // ==========================
    // INITIALIZATION & LISTENERS
    // ==========================
    document.addEventListener('DOMContentLoaded', () => {
        // Populate year dropdowns
        const currentYear = new Date().getFullYear();
        document.querySelectorAll('#year, #editYear').forEach(sel => {
            for (let y = currentYear + 1; y >= 2000; y--) sel.append(new Option(y, y));
        });
        document.getElementById('date').value = getTodayDate();
        setupSorting();

        // Firebase Listeners
        db.collection('pending_vehicles').onSnapshot(snapshot => {
            pendingData = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
            renderTable('pending', 'pendingTable', pendingData, currentPendingPage, PENDING_PAGE_SIZE, createPendingRow, 'No pending vehicles.');
        }, err => { console.error(err); showToast('Error loading pending vehicles.'); });

        db.collection('vehicles').onSnapshot(snapshot => {
            completedData = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
            document.getElementById('searchCompleted').dispatchEvent(new Event('input'));
            renderDailySummary(document.getElementById('summaryDatePicker').value);
            renderRecaptureAlerts();
        }, err => { console.error(err); showToast('Error loading completed vehicles.'); });
        
        // Event Listeners
        document.getElementById('searchCompleted').addEventListener('input', e => {
            const term = e.target.value.toLowerCase();
            filteredCompletedData = completedData.filter(item => {
                const d = item.data;
                const searchableString = Object.values(d).join(' ').toLowerCase();
                const stockOrVin = (d.vinOrStock || d.stock || '').toLowerCase();
                return searchableString.includes(term) || stockOrVin.includes(term);
            });
            renderTable('completed', 'completedTable', filteredCompletedData, 0, COMPLETED_PAGE_SIZE, createCompletedRow, 'No results found.');
        });
        
        document.getElementById('saveEditBtn').addEventListener('click', async () => {
            const id = currentEdit.id;
            const collection = currentEdit.collection;
            
            const descriptionFeatures = {
                mileage: document.getElementById('editMileage').value.trim(),
                appleCarPlay: document.getElementById('editCarplay').checked,
                blindSpot: document.getElementById('editBlindSpot').checked,
                bluetooth: document.getElementById('editBluetooth').checked,
                heatedSeats: document.getElementById('editHeatedSeats').checked,
                heatedSteering: document.getElementById('editHeatedSteering').checked,
                inbuiltNav: document.getElementById('editInbuiltNav').checked,
                leatherSeats: document.getElementById('editLeatherSeats').checked,
                multiZoneClimate: document.getElementById('editMultiZoneClimate').checked,
                parkingSensors: document.getElementById('editParkingSensors').checked,
                premiumSound: document.getElementById('editPremiumSound').checked,
                sunroof: document.getElementById('editSunroof').checked,
                ventilatedSeats: document.getElementById('editVentilatedSeats').checked,
                wirelessCharger: document.getElementById('editWirelessCharger').checked,
                other: document.getElementById('editOtherFeatures').value.trim(),
            };

            const data = {
                vinOrStock: document.getElementById('editVinOrStock').value.trim().toUpperCase(),
                make: capitalizeFirst(document.getElementById('editMake').value.trim()),
                model: capitalizeFirst(document.getElementById('editModel').value.trim()),
                trim: document.getElementById('editTrim').value.trim(),
                year: document.getElementById('editYear').value,
                date: document.getElementById('editDate').value,
                comment: document.getElementById('editComment').value,
                descriptionFeatures: descriptionFeatures,
                link: document.getElementById('editLink').value.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                mileage: firebase.firestore.FieldValue.delete() // remove old top-level field
            };

            showSpinner();
            try {
                await db.collection(collection).doc(id).update(data);
                showToast('Changes saved!');
                closeModal();
            } catch (e) { console.error(e); showToast('Error saving changes.'); } finally { hideSpinner(); }
        });
        
        document.querySelectorAll('.btn-toggle-group .btn').forEach(button => {
            button.addEventListener('click', () => {
                const group = button.dataset.group;
                document.querySelectorAll(`[data-group="${group}"]`).forEach(btn => {
                    btn.classList.remove('active', 'btn-primary');
                    btn.classList.add('btn-secondary');
                });
                button.classList.add('active', 'btn-primary');
                button.classList.remove('btn-secondary');

                if (group === 'photos') {
                    document.getElementById('halfReasonContainer').classList.toggle('hidden', button.dataset.value !== 'HP');
                }
                if (group === 'recapture') {
                    document.getElementById('recaptureCommentContainer').classList.toggle('hidden', button.dataset.value !== 'Yes');
                }
            });
        });

        document.getElementById('pendingPrevBtn').onclick = () => renderTable('pending', 'pendingTable', pendingData, currentPendingPage - 1, PENDING_PAGE_SIZE, createPendingRow, 'No pending vehicles.');
        document.getElementById('pendingNextBtn').onclick = () => renderTable('pending', 'pendingTable', pendingData, currentPendingPage + 1, PENDING_PAGE_SIZE, createPendingRow, 'No pending vehicles.');
        document.getElementById('completedPrevBtn').onclick = () => renderTable('completed', 'completedTable', filteredCompletedData, currentCompletedPage - 1, COMPLETED_PAGE_SIZE, createCompletedRow, 'No completed vehicles.');
        document.getElementById('completedNextBtn').onclick = () => renderTable('completed', 'completedTable', filteredCompletedData, currentCompletedPage + 1, COMPLETED_PAGE_SIZE, createCompletedRow, 'No completed vehicles.');
        
        const summaryDatePicker = document.getElementById('summaryDatePicker');
        summaryDatePicker.value = getTodayDate();
        summaryDatePicker.addEventListener('change', (e) => {
            renderDailySummary(e.target.value);
        });

        document.getElementById('dailySummaryPrevBtn').onclick = () => renderDailySummary(summaryDatePicker.value, currentDailySummaryPage - 1);
        document.getElementById('dailySummaryNextBtn').onclick = () => renderDailySummary(summaryDatePicker.value, currentDailySummaryPage + 1);
        
        document.getElementById('confirmCancelBtn').addEventListener('click', closeConfirmModal);
        document.getElementById('confirmOkBtn').addEventListener('click', () => {
            if (typeof onConfirmCallback === 'function') {
                onConfirmCallback();
            }
            closeConfirmModal();
        });
    });

    function setupSorting() {
        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.col;
                const tableKey = th.closest('table').querySelector('tbody').id.includes('pending') ? 'pending' : 'completed';
                
                if (sortState[tableKey].col === column) {
                    sortState[tableKey].dir = sortState[tableKey].dir === 'asc' ? 'desc' : 'asc';
                } else {
                    sortState[tableKey].col = column;
                    sortState[tableKey].dir = 'asc';
                }

                document.querySelectorAll(`#${tableKey}Table th.sortable`).forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
                th.classList.add(sortState[tableKey].dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
                
                if (tableKey === 'pending') {
                    renderTable('pending', 'pendingTable', pendingData, currentPendingPage, PENDING_PAGE_SIZE, createPendingRow, 'No pending vehicles.');
                } else {
                    renderTable('completed', 'completedTable', filteredCompletedData, currentCompletedPage, COMPLETED_PAGE_SIZE, createCompletedRow, 'No completed vehicles.');
                }
            });
        });
    }
</script>
</body>
</html>

